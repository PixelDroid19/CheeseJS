# üîÑ Gu√≠a de Migraci√≥n - CheeseJS v2.0

## üìã Lista de Verificaci√≥n de Migraci√≥n

### ‚úÖ Cambios Obligatorios

- [ ] **Actualizar imports** de managers a servicios unificados
- [ ] **Reemplazar l√≥gica de inicializaci√≥n** con hooks personalizados
- [ ] **Migrar gesti√≥n de eventos** al EventManager
- [ ] **Convertir paneles hardcoded** a sistema de plugins
- [ ] **Actualizar tests** para nueva arquitectura
- [ ] **Verificar dependencias** y versiones compatibles

### ‚ö†Ô∏è Breaking Changes

| Componente | Antes | Despu√©s |
|------------|-------|---------|
| `webContainerManager` | Instancia separada | `webContainerService` |
| `packageManager` | Instancia separada | M√©todo en `webContainerService` |
| `codeExecutor` | Instancia separada | M√©todo en `webContainerService` |
| Inicializaci√≥n i18n | Manual en cada componente | Hook `useI18n` |
| Gesti√≥n de eventos | Manual con cleanup | Hook `useEventManager` |

---

## üîß Migraci√≥n por Componentes

### 1. HeaderBar Component

#### Antes (‚ùå C√≥digo duplicado)
```javascript
import React, { useState, useEffect } from 'react';
import { i18nService } from '../../services/i18n-service.js';
import { eventBus } from '../../utils/event-bus.js';

export const HeaderBar = () => {
  const [currentLanguage, setCurrentLanguage] = useState('es');
  const [isExecuting, setIsExecuting] = useState(false);
  const [t, setT] = useState(() => (key) => key);

  useEffect(() => {
    // Inicializaci√≥n duplicada
    const initializeI18n = async () => {
      await i18nService.initialize();
      setCurrentLanguage(i18nService.getCurrentLanguage());
      setT(() => (key) => i18nService.t(key));
    };
    initializeI18n();

    // Eventos manuales
    const unsubscribers = [
      eventBus.subscribe('i18n:language-changed', (data) => {
        setCurrentLanguage(data.to);
        setT(() => (key) => i18nService.t(key));
      }),
      eventBus.subscribe('execution:started', () => setIsExecuting(true)),
      eventBus.subscribe('execution:completed', () => setIsExecuting(false)),
      eventBus.subscribe('execution:error', () => setIsExecuting(false))
    ];

    return () => {
      unsubscribers.forEach(unsub => unsub());
    };
  }, []);

  const handleRunCode = () => {
    if (isExecuting) {
      eventBus.emit('code:stop-requested');
    } else {
      eventBus.emit('code:run-requested');
    }
  };

  // ... resto del componente
};
```

#### Despu√©s (‚úÖ Hooks y EventManager)
```javascript
import React, { useState, useEffect } from 'react';
import { useI18n } from '../../hooks/use-i18n.js';
import { useExecution } from '../../hooks/use-execution.js';
import { useEventGroup } from '../../hooks/use-event-manager.js';

export const HeaderBar = () => {
  // ‚úÖ Un solo hook para i18n - sin duplicaci√≥n
  const { currentLanguage, t, changeLanguage, isReady } = useI18n();
  
  // ‚úÖ Un solo hook para ejecuci√≥n - estado centralizado
  const { isExecuting, executeCode, stopExecution } = useExecution();
  
  // ‚úÖ EventManager con cleanup autom√°tico
  const { emit } = useEventGroup('header-bar', 'UI_BASIC', {
    languageChanged: (data) => {
      console.log('üåç Idioma cambi√≥:', data);
    },
    themeChanged: (data) => {
      console.log('üé® Tema cambi√≥:', data);
    }
  });

  const handleRunCode = () => {
    if (isExecuting) {
      stopExecution();
    } else {
      emit('code:run-requested');
    }
  };

  if (!isReady) return <Loading />;

  // ... resto del componente simplificado
};
```

**Beneficios de la migraci√≥n:**
- ‚úÖ **-25 l√≠neas** de c√≥digo boilerplate
- ‚úÖ **Sin duplicaci√≥n** de l√≥gica de inicializaci√≥n
- ‚úÖ **Cleanup autom√°tico** de eventos
- ‚úÖ **Estado consistente** entre componentes

### 2. DevPanel Component

#### Antes (‚ùå Sistema hardcoded)
```javascript
export const DevPanel = () => {
  const [registeredPanels, setRegisteredPanels] = useState(new Map());
  const [activeTab, setActiveTab] = useState('output');

  const registerDefaultPanels = () => {
    // ‚ùå Paneles hardcoded
    const defaultPanels = [
      { id: 'output', component: OutputPanel },
      { id: 'terminal', component: TerminalPanel },
      // ... m√°s paneles hardcoded
    ];

    defaultPanels.forEach(panel => {
      // ‚ùå L√≥gica de registro manual
      setRegisteredPanels(prev => {
        const newPanels = new Map(prev);
        newPanels.set(panel.id, panel);
        return newPanels;
      });
    });
  };

  useEffect(() => {
    registerDefaultPanels(); // ‚ùå No extensible
  }, []);

  // ... m√°s c√≥digo duplicado
};
```

#### Despu√©s (‚úÖ Sistema de plugins)
```javascript
import { useDevPanel } from '../../hooks/use-dev-panel.js';
import { registerDefaultPanels } from '../../core/default-panels.js';

export const DevPanel = () => {
  // ‚úÖ Hook que maneja todo el estado
  const {
    activeTab,
    panels,
    availablePanels,
    isInitialized,
    switchTab,
    updatePanelState,
    getPanelState
  } = useDevPanel();

  useEffect(() => {
    // ‚úÖ Registro autom√°tico via plugins
    registerDefaultPanels();
  }, []);

  // ‚úÖ Componente simplificado - la l√≥gica est√° en el hook
  if (!isInitialized) return <Loading />;

  return (
    <div className="dev-panel">
      <PanelTabManager
        panels={availablePanels}
        activeTab={activeTab}
        onTabClick={switchTab}
      />
      <PanelContent />
    </div>
  );
};

// ‚úÖ Ahora es f√°cil agregar paneles din√°micamente
const addCustomPanel = () => {
  pluginRegistry.registerPlugin({
    id: 'my-panel',
    type: 'panel',
    component: MyCustomPanel
  });
};
```

### 3. Core Services

#### Antes (‚ùå M√∫ltiples managers)
```javascript
class CheeseJSCore {
  constructor() {
    // ‚ùå 5 managers para una sola instancia de WebContainer
    this.webContainerManager = new WebContainerManager();
    this.packageManager = new PackageManager(this.webContainerManager);
    this.codeExecutor = new CodeExecutor(this.webContainerManager);
    this.sandboxManager = new SandboxManager(this.webContainerManager);
    this.terminalManager = new TerminalManager(this.webContainerManager);
  }

  async executeCode(code) {
    // ‚ùå Delegaci√≥n a m√∫ltiples managers
    return await this.codeExecutor.executeCode(code);
  }

  async installPackage(pkg) {
    // ‚ùå M√°s delegaci√≥n
    return await this.packageManager.installPackage(pkg);
  }
}
```

#### Despu√©s (‚úÖ Servicio unificado)
```javascript
class CheeseJSCore {
  constructor() {
    // ‚úÖ Un solo servicio que hace todo
    this.webContainerService = new WebContainerService();
  }

  async executeCode(code) {
    // ‚úÖ Directo, sin delegaci√≥n innecesaria
    return await this.webContainerService.executeCode(code);
  }

  async installPackage(pkg) {
    // ‚úÖ API consistente
    return await this.webContainerService.installPackage(pkg);
  }
}
```

---

## üîÑ Script de Migraci√≥n Autom√°tica

```javascript
// migrate.js - Script para ayudar con la migraci√≥n
const fs = require('fs');
const path = require('path');

const migrations = [
  {
    name: 'Update service imports',
    pattern: /import.*from.*webcontainer-manager/g,
    replacement: "import WebContainerService from './webcontainer-service.js'"
  },
  {
    name: 'Replace i18n initialization',
    pattern: /const initializeI18n[\s\S]*?setT\(\(\) => \(key.*?\) => i18nService\.t\(key.*?\)\);/g,
    replacement: 'const { t, currentLanguage, isReady } = useI18n();'
  },
  {
    name: 'Replace event subscriptions',
    pattern: /const unsubscribers = \[[\s\S]*?eventBus\.subscribe[\s\S]*?\];[\s\S]*?return \(\) => \{[\s\S]*?unsubscribers\.forEach\(unsub => unsub\(\)\);[\s\S]*?\};/g,
    replacement: 'const { emit } = useEventGroup(componentId, eventGroupName, handlers);'
  }
];

function migrateFile(filePath) {
  let content = fs.readFileSync(filePath, 'utf8');
  
  migrations.forEach(migration => {
    content = content.replace(migration.pattern, migration.replacement);
  });
  
  fs.writeFileSync(filePath, content);
  console.log(`‚úÖ Migrated: ${filePath}`);
}

// Ejecutar migraci√≥n
const srcDir = './src';
const files = getAllJsxFiles(srcDir);
files.forEach(migrateFile);
```

---

## üß™ Actualizaci√≥n de Tests

### Antes (‚ùå Tests complejos)
```javascript
describe('HeaderBar', () => {
  it('should initialize i18n', async () => {
    const mockInitialize = jest.fn();
    const mockGetCurrentLanguage = jest.fn().mockReturnValue('es');
    
    // ‚ùå Muchos mocks necesarios
    jest.mock('../../services/i18n-service.js', () => ({
      i18nService: {
        initialize: mockInitialize,
        getCurrentLanguage: mockGetCurrentLanguage,
        t: jest.fn(key => key)
      }
    }));

    // ‚ùå Test complejo para funcionalidad b√°sica
    render(<HeaderBar />);
    
    await waitFor(() => {
      expect(mockInitialize).toHaveBeenCalled();
      expect(mockGetCurrentLanguage).toHaveBeenCalled();
    });
  });
});
```

### Despu√©s (‚úÖ Tests simples)
```javascript
describe('HeaderBar', () => {
  it('should display translated content', () => {
    // ‚úÖ Mock simple del hook
    const mockUseI18n = {
      t: jest.fn(key => `translated_${key}`),
      currentLanguage: 'es',
      isReady: true
    };
    
    jest.mock('../../hooks/use-i18n.js', () => ({
      useI18n: () => mockUseI18n
    }));

    // ‚úÖ Test directo y simple
    render(<HeaderBar />);
    
    expect(screen.getByText('translated_welcome')).toBeInTheDocument();
  });
});
```

---

## üìù Checklist de Verificaci√≥n Post-Migraci√≥n

### Funcionalidad ‚úÖ
- [ ] La aplicaci√≥n inicia correctamente
- [ ] El cambio de idioma funciona
- [ ] El cambio de tema funciona
- [ ] La ejecuci√≥n de c√≥digo funciona
- [ ] La instalaci√≥n de paquetes funciona
- [ ] Los paneles se muestran correctamente
- [ ] Los eventos se propagan correctamente

### Performance ‚úÖ
- [ ] El tiempo de inicializaci√≥n mejor√≥
- [ ] El uso de memoria se redujo
- [ ] No hay memory leaks de eventos
- [ ] Los hooks se re-renderizan apropiadamente

### Code Quality ‚úÖ
- [ ] Se elimin√≥ c√≥digo duplicado
- [ ] Los componentes son m√°s peque√±os
- [ ] Los tests pasan todos
- [ ] No hay warnings en consola
- [ ] ESLint pasa sin errores

### Extensibilidad ‚úÖ
- [ ] Se pueden agregar paneles via plugins
- [ ] Los nuevos hooks son reutilizables
- [ ] El EventManager maneja nuevos eventos
- [ ] La API es consistente

---

## üÜò Troubleshooting

### Problema: "Hook must be called inside a function component"

```javascript
// ‚ùå Problema
const { t } = useI18n(); // Fuera del componente

function MyComponent() {
  return <div>{t('key')}</div>;
}

// ‚úÖ Soluci√≥n
function MyComponent() {
  const { t } = useI18n(); // Dentro del componente
  return <div>{t('key')}</div>;
}
```

### Problema: "Service not initialized"

```javascript
// ‚ùå Problema
const { t } = useI18n();
return <div>{t('key')}</div>; // Error si no est√° listo

// ‚úÖ Soluci√≥n
const { t, isReady } = useI18n();
if (!isReady) return <Loading />;
return <div>{t('key')}</div>;
```

### Problema: "Plugin not registered"

```javascript
// ‚ùå Problema
pluginRegistry.registerPlugin({
  id: 'my-panel',
  name: 'My Panel'
  // Falta type y component
});

// ‚úÖ Soluci√≥n
pluginRegistry.registerPlugin({
  id: 'my-panel',
  name: 'My Panel',
  type: 'panel',
  component: MyPanelComponent
});
```

---

## üéØ Beneficios Post-Migraci√≥n

### Para Desarrolladores
- ‚úÖ **Menos c√≥digo boilerplate** - hooks manejan la complejidad
- ‚úÖ **Reutilizaci√≥n f√°cil** - mismos hooks en m√∫ltiples componentes
- ‚úÖ **Tests m√°s simples** - mock de hooks en lugar de servicios
- ‚úÖ **Extensibilidad** - agregar funcionalidad via plugins

### Para la Aplicaci√≥n
- ‚úÖ **Menor tiempo de inicializaci√≥n** - servicios unificados
- ‚úÖ **Menor uso de memoria** - menos instancias duplicadas
- ‚úÖ **Mejor performance** - event management optimizado
- ‚úÖ **M√°s estable** - menos duplicaci√≥n = menos bugs

### Para el Proyecto
- ‚úÖ **M√°s mantenible** - arquitectura clara y modular
- ‚úÖ **M√°s escalable** - sistema de plugins extensible
- ‚úÖ **Mejor DX** - herramientas de desarrollo mejoradas
- ‚úÖ **Futuro-proof** - base s√≥lida para nuevas features

---

*üéâ ¬°Felicitaciones! Has migrado exitosamente a CheeseJS v2.0. La nueva arquitectura te permitir√° desarrollar funcionalidades m√°s r√°pido y con mayor confianza.*